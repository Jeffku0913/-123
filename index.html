<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💰 簡易記帳（可匯出 Excel）</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel (讓瀏覽器能執行 JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- SheetJS (Excel 匯出/匯入) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const CATEGORIES = ["餐飲","交通","購物","娛樂","醫療","居家","教育","旅行","薪資","其他"];
    const METHODS = ["現金","信用卡","轉帳","悠遊卡","LinePay","街口","其他"];

    function uid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function numberFormat(n) {
      return new Intl.NumberFormat("zh-TW", { maximumFractionDigits: 2 }).format(n);
    }

    function buildSummary(src) {
      const map = new Map();
      for (const e of src) {
        const ym = String(e.date || "").slice(0, 7);
        const key = ym + "|" + (e.category || "其他");
        map.set(key, (map.get(key) || 0) + Number(e.amount || 0));
      }
      const rows = [];
      for (const [key, val] of map.entries()) {
        const [ym, category] = key.split("|");
        rows.push({ ym, category, total: Number(val.toFixed(2)) });
      }
      rows.sort((a, b) => (a.ym === b.ym ? a.category.localeCompare(b.category) : a.ym.localeCompare(b.ym)));
      return rows;
    }

    function SummaryTable({ entries }) {
      const rows = useMemo(() => buildSummary(entries), [entries]);
      if (!rows.length) return <div className="text-slate-400">沒有可彙總的資料</div>;
      return (
        <table className="w-full text-sm">
          <thead>
            <tr className="border-b bg-slate-50 text-slate-600">
              <th className="text-left p-2">月份</th>
              <th className="text-left p-2">分類</th>
              <th className="text-right p-2">總金額</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r, i) => (
              <tr key={i} className="border-b last:border-0 hover:bg-slate-50">
                <td className="p-2">{r.ym}</td>
                <td className="p-2">{r.category}</td>
                <td className="p-2 text-right font-medium">{numberFormat(r.total)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      );
    }

    function App() {
      const [entries, setEntries] = useState([]);
      const [query, setQuery] = useState("");
      const [categoryFilter, setCategoryFilter] = useState("");
      const [monthFilter, setMonthFilter] = useState("");
      const [methodFilter, setMethodFilter] = useState("");

      const [form, setForm] = useState({
        date: new Date().toISOString().slice(0, 10),
        category: "餐飲",
        method: "現金",
        amount: 0,
        item: "",
        note: ""
      });
      const [editingId, setEditingId] = useState(null);

      // 載入 localStorage
      useEffect(() => {
        const raw = localStorage.getItem("ledger_entries_v1");
        if (raw) setEntries(JSON.parse(raw));
      }, []);
      // 儲存到 localStorage
      useEffect(() => {
        localStorage.setItem("ledger_entries_v1", JSON.stringify(entries));
      }, [entries]);

      function upsertEntry(e) {
        e.preventDefault();
        if (!form.date || !form.item) return;
        const amountNum = Number(form.amount);
        if (Number.isNaN(amountNum)) return alert("金額需為數字");

        const payload = { ...form, id: editingId || uid(), amount: amountNum };
        setEntries(prev => {
          if (editingId) return prev.map(p => (p.id === editingId ? payload : p));
          return [payload, ...prev];
        });

        setForm({
          date: new Date().toISOString().slice(0, 10),
          category: "餐飲",
          method: "現金",
          amount: 0,
          item: "",
          note: ""
        });
        setEditingId(null);
      }

      function onEdit(entry) {
        setEditingId(entry.id);
        setForm({ ...entry });
      }

      function onDelete(id) {
        if (confirm("確定要刪除嗎？")) {
          setEntries(prev => prev.filter(p => p.id !== id));
        }
      }

      function exportExcel() {
        if (!entries.length) return alert("沒有資料可匯出");
        const ws = XLSX.utils.json_to_sheet(entries.map(({ id, ...rest }) => rest));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "記帳");
        const ws2 = XLSX.utils.json_to_sheet(buildSummary(entries));
        XLSX.utils.book_append_sheet(wb, ws2, "彙總");
        XLSX.writeFile(wb, "ledger.xlsx");
      }

      const filtered = useMemo(() => {
        return entries.filter(e =>
          (!query || [e.item, e.category, e.note, e.method].some(t => String(t||"").includes(query)) || String(e.amount).includes(query)) &&
          (!categoryFilter || e.category === categoryFilter) &&
          (!methodFilter || e.method === methodFilter) &&
          (!monthFilter || e.date.slice(0, 7) === monthFilter)
        );
      }, [entries, query, categoryFilter, monthFilter, methodFilter]);

      const total = filtered.reduce((a, c) => a + Number(c.amount || 0), 0);

      return (
        <div>
          <header className="bg-white border-b p-4 flex justify-between items-center">
            <h1 className="text-xl font-bold">💰 簡易記帳</h1>
            <div className="flex gap-2">
              <button onClick={exportExcel} className="px-3 py-1 bg-emerald-600 text-white rounded">匯出 Excel</button>
              <button onClick={() => setEntries([])} className="px-3 py-1 bg-rose-600 text-white rounded">清空</button>
            </div>
          </header>

          <main className="max-w-3xl mx-auto p-4 space-y-6">
            <form onSubmit={upsertEntry} className="grid grid-cols-2 gap-2 bg-white p-4 rounded shadow">
              <input type="date" value={form.date} onChange={e=>setForm(f=>({...f,date:e.target.value}))} className="border p-2 rounded" required/>
              <input placeholder="品項" value={form.item} onChange={e=>setForm(f=>({...f,item:e.target.value}))} className="border p-2 rounded" required/>
              <select value={form.category} onChange={e=>setForm(f=>({...f,category:e.target.value}))} className="border p-2 rounded">
                {CATEGORIES.map(c=><option key={c}>{c}</option>)}
              </select>
              <select value={form.method} onChange={e=>setForm(f=>({...f,method:e.target.value}))} className="border p-2 rounded">
                {METHODS.map(m=><option key={m}>{m}</option>)}
              </select>
              <input type="number" value={form.amount} onChange={e=>setForm(f=>({...f,amount:e.target.value}))} placeholder="金額" className="border p-2 rounded" required/>
              <input placeholder="備註" value={form.note} onChange={e=>setForm(f=>({...f,note:e.target.value}))} className="border p-2 rounded col-span-2"/>
              <button type="submit" className="col-span-2 bg-slate-900 text-white py-2 rounded">{editingId ? "更新紀錄" : "新增紀錄"}</button>
            </form>

            <div className="bg-white p-4 rounded shadow">
              <h2 className="font-semibold mb-2">篩選 / 搜尋</h2>
              <input placeholder="關鍵字" value={query} onChange={e=>setQuery(e.target.value)} className="border p-2 rounded w-full mb-2"/>
              <div className="flex gap-2">
                <select value={categoryFilter} onChange={e=>setCategoryFilter(e.target.value)} className="border p-2 rounded flex-1">
                  <option value="">所有分類</option>
                  {CATEGORIES.map(c=><option key={c}>{c}</option>)}
                </select>
                <select value={methodFilter} onChange={e=>setMethodFilter(e.target.value)} className="border p-2 rounded flex-1">
                  <option value="">所有付款</option>
                  {METHODS.map(m=><option key={m}>{m}</option>)}
                </select>
                <input type="month" value={monthFilter} onChange={e=>setMonthFilter(e.target.value)} className="border p-2 rounded flex-1"/>
              </div>
              <div className="mt-2 text-sm">筆數：{filtered.length}，合計：{numberFormat(total)}</div>
            </div>

            <div className="bg-white p-4 rounded shadow overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-2">日期</th>
                    <th className="text-left p-2">品項</th>
                    <th className="text-left p-2">分類</th>
                    <th className="text-right p-2">金額</th>
                    <th className="text-left p-2">付款</th>
                    <th className="text-left p-2">備註</th>
                    <th className="p-2">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.map(e=>(
                    <tr key={e.id} className="border-b">
                      <td className="p-2">{e.date}</td>
                      <td className="p-2">{e.item}</td>
                      <td className="p-2">{e.category}</td>
                      <td className="p-2 text-right">{numberFormat(e.amount)}</td>
                      <td className="p-2">{e.method}</td>
                      <td className="p-2">{e.note}</td>
                      <td className="p-2">
                        <button onClick={()=>onEdit(e)} className="text-blue-600 mr-2">編輯</button>
                        <button onClick={()=>onDelete(e.id)} className="text-red-600">刪除</button>
                      </td>
                    </tr>
                  ))}
                  {!filtered.length && <tr><td colSpan="7" className="text-center p-4 text-slate-400">目前沒有資料</td></tr>}
                </tbody>
              </table>
            </div>

            <div className="bg-white p-4 rounded shadow">
              <h2 className="font-semibold mb-2">月度/分類彙總</h2>
              <SummaryTable entries={filtered}/>
            </div>
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
