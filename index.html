<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’° ç°¡æ˜“è¨˜å¸³ï¼ˆå¯åŒ¯å‡º Excelï¼‰</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel (è®“ç€è¦½å™¨èƒ½åŸ·è¡Œ JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- SheetJS (Excel åŒ¯å‡º/åŒ¯å…¥) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const CATEGORIES = ["é¤é£²","äº¤é€š","è³¼ç‰©","å¨›æ¨‚","é†«ç™‚","å±…å®¶","æ•™è‚²","æ—…è¡Œ","è–ªè³‡","å…¶ä»–"];
    const METHODS = ["ç¾é‡‘","ä¿¡ç”¨å¡","è½‰å¸³","æ‚ éŠå¡","LinePay","è¡—å£","å…¶ä»–"];

    function uid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function numberFormat(n) {
      return new Intl.NumberFormat("zh-TW", { maximumFractionDigits: 2 }).format(n);
    }

    function buildSummary(src) {
      const map = new Map();
      for (const e of src) {
        const ym = String(e.date || "").slice(0, 7);
        const key = ym + "|" + (e.category || "å…¶ä»–");
        map.set(key, (map.get(key) || 0) + Number(e.amount || 0));
      }
      const rows = [];
      for (const [key, val] of map.entries()) {
        const [ym, category] = key.split("|");
        rows.push({ ym, category, total: Number(val.toFixed(2)) });
      }
      rows.sort((a, b) => (a.ym === b.ym ? a.category.localeCompare(b.category) : a.ym.localeCompare(b.ym)));
      return rows;
    }

    function SummaryTable({ entries }) {
      const rows = useMemo(() => buildSummary(entries), [entries]);
      if (!rows.length) return <div className="text-slate-400">æ²’æœ‰å¯å½™ç¸½çš„è³‡æ–™</div>;
      return (
        <table className="w-full text-sm">
          <thead>
            <tr className="border-b bg-slate-50 text-slate-600">
              <th className="text-left p-2">æœˆä»½</th>
              <th className="text-left p-2">åˆ†é¡</th>
              <th className="text-right p-2">ç¸½é‡‘é¡</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r, i) => (
              <tr key={i} className="border-b last:border-0 hover:bg-slate-50">
                <td className="p-2">{r.ym}</td>
                <td className="p-2">{r.category}</td>
                <td className="p-2 text-right font-medium">{numberFormat(r.total)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      );
    }

    function App() {
      const [entries, setEntries] = useState([]);
      const [query, setQuery] = useState("");
      const [categoryFilter, setCategoryFilter] = useState("");
      const [monthFilter, setMonthFilter] = useState("");
      const [methodFilter, setMethodFilter] = useState("");

      const [form, setForm] = useState({
        date: new Date().toISOString().slice(0, 10),
        category: "é¤é£²",
        method: "ç¾é‡‘",
        amount: 0,
        item: "",
        note: ""
      });
      const [editingId, setEditingId] = useState(null);

      // è¼‰å…¥ localStorage
      useEffect(() => {
        const raw = localStorage.getItem("ledger_entries_v1");
        if (raw) setEntries(JSON.parse(raw));
      }, []);
      // å„²å­˜åˆ° localStorage
      useEffect(() => {
        localStorage.setItem("ledger_entries_v1", JSON.stringify(entries));
      }, [entries]);

      function upsertEntry(e) {
        e.preventDefault();
        if (!form.date || !form.item) return;
        const amountNum = Number(form.amount);
        if (Number.isNaN(amountNum)) return alert("é‡‘é¡éœ€ç‚ºæ•¸å­—");

        const payload = { ...form, id: editingId || uid(), amount: amountNum };
        setEntries(prev => {
          if (editingId) return prev.map(p => (p.id === editingId ? payload : p));
          return [payload, ...prev];
        });

        setForm({
          date: new Date().toISOString().slice(0, 10),
          category: "é¤é£²",
          method: "ç¾é‡‘",
          amount: 0,
          item: "",
          note: ""
        });
        setEditingId(null);
      }

      function onEdit(entry) {
        setEditingId(entry.id);
        setForm({ ...entry });
      }

      function onDelete(id) {
        if (confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) {
          setEntries(prev => prev.filter(p => p.id !== id));
        }
      }

      function exportExcel() {
        if (!entries.length) return alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
        const ws = XLSX.utils.json_to_sheet(entries.map(({ id, ...rest }) => rest));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "è¨˜å¸³");
        const ws2 = XLSX.utils.json_to_sheet(buildSummary(entries));
        XLSX.utils.book_append_sheet(wb, ws2, "å½™ç¸½");
        XLSX.writeFile(wb, "ledger.xlsx");
      }

      const filtered = useMemo(() => {
        return entries.filter(e =>
          (!query || [e.item, e.category, e.note, e.method].some(t => String(t||"").includes(query)) || String(e.amount).includes(query)) &&
          (!categoryFilter || e.category === categoryFilter) &&
          (!methodFilter || e.method === methodFilter) &&
          (!monthFilter || e.date.slice(0, 7) === monthFilter)
        );
      }, [entries, query, categoryFilter, monthFilter, methodFilter]);

      const total = filtered.reduce((a, c) => a + Number(c.amount || 0), 0);

      return (
        <div>
          <header className="bg-white border-b p-4 flex justify-between items-center">
            <h1 className="text-xl font-bold">ğŸ’° ç°¡æ˜“è¨˜å¸³</h1>
            <div className="flex gap-2">
              <button onClick={exportExcel} className="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º Excel</button>
              <button onClick={() => setEntries([])} className="px-3 py-1 bg-rose-600 text-white rounded">æ¸…ç©º</button>
            </div>
          </header>

          <main className="max-w-3xl mx-auto p-4 space-y-6">
            <form onSubmit={upsertEntry} className="grid grid-cols-2 gap-2 bg-white p-4 rounded shadow">
              <input type="date" value={form.date} onChange={e=>setForm(f=>({...f,date:e.target.value}))} className="border p-2 rounded" required/>
              <input placeholder="å“é …" value={form.item} onChange={e=>setForm(f=>({...f,item:e.target.value}))} className="border p-2 rounded" required/>
              <select value={form.category} onChange={e=>setForm(f=>({...f,category:e.target.value}))} className="border p-2 rounded">
                {CATEGORIES.map(c=><option key={c}>{c}</option>)}
              </select>
              <select value={form.method} onChange={e=>setForm(f=>({...f,method:e.target.value}))} className="border p-2 rounded">
                {METHODS.map(m=><option key={m}>{m}</option>)}
              </select>
              <input type="number" value={form.amount} onChange={e=>setForm(f=>({...f,amount:e.target.value}))} placeholder="é‡‘é¡" className="border p-2 rounded" required/>
              <input placeholder="å‚™è¨»" value={form.note} onChange={e=>setForm(f=>({...f,note:e.target.value}))} className="border p-2 rounded col-span-2"/>
              <button type="submit" className="col-span-2 bg-slate-900 text-white py-2 rounded">{editingId ? "æ›´æ–°ç´€éŒ„" : "æ–°å¢ç´€éŒ„"}</button>
            </form>

            <div className="bg-white p-4 rounded shadow">
              <h2 className="font-semibold mb-2">ç¯©é¸ / æœå°‹</h2>
              <input placeholder="é—œéµå­—" value={query} onChange={e=>setQuery(e.target.value)} className="border p-2 rounded w-full mb-2"/>
              <div className="flex gap-2">
                <select value={categoryFilter} onChange={e=>setCategoryFilter(e.target.value)} className="border p-2 rounded flex-1">
                  <option value="">æ‰€æœ‰åˆ†é¡</option>
                  {CATEGORIES.map(c=><option key={c}>{c}</option>)}
                </select>
                <select value={methodFilter} onChange={e=>setMethodFilter(e.target.value)} className="border p-2 rounded flex-1">
                  <option value="">æ‰€æœ‰ä»˜æ¬¾</option>
                  {METHODS.map(m=><option key={m}>{m}</option>)}
                </select>
                <input type="month" value={monthFilter} onChange={e=>setMonthFilter(e.target.value)} className="border p-2 rounded flex-1"/>
              </div>
              <div className="mt-2 text-sm">ç­†æ•¸ï¼š{filtered.length}ï¼Œåˆè¨ˆï¼š{numberFormat(total)}</div>
            </div>

            <div className="bg-white p-4 rounded shadow overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-2">æ—¥æœŸ</th>
                    <th className="text-left p-2">å“é …</th>
                    <th className="text-left p-2">åˆ†é¡</th>
                    <th className="text-right p-2">é‡‘é¡</th>
                    <th className="text-left p-2">ä»˜æ¬¾</th>
                    <th className="text-left p-2">å‚™è¨»</th>
                    <th className="p-2">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.map(e=>(
                    <tr key={e.id} className="border-b">
                      <td className="p-2">{e.date}</td>
                      <td className="p-2">{e.item}</td>
                      <td className="p-2">{e.category}</td>
                      <td className="p-2 text-right">{numberFormat(e.amount)}</td>
                      <td className="p-2">{e.method}</td>
                      <td className="p-2">{e.note}</td>
                      <td className="p-2">
                        <button onClick={()=>onEdit(e)} className="text-blue-600 mr-2">ç·¨è¼¯</button>
                        <button onClick={()=>onDelete(e.id)} className="text-red-600">åˆªé™¤</button>
                      </td>
                    </tr>
                  ))}
                  {!filtered.length && <tr><td colSpan="7" className="text-center p-4 text-slate-400">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>}
                </tbody>
              </table>
            </div>

            <div className="bg-white p-4 rounded shadow">
              <h2 className="font-semibold mb-2">æœˆåº¦/åˆ†é¡å½™ç¸½</h2>
              <SummaryTable entries={filtered}/>
            </div>
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
