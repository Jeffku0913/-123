<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💰 簡易記帳（含收入/支出圖表、可匯出 Excel）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
    const CATEGORIES = ["餐飲","交通","購物","娛樂","醫療","居家","教育","旅行","薪資","其他"];
    const METHODS = ["現金","信用卡","轉帳","悠遊卡","LinePay","街口","其他"];
    const uid = ()=> Math.random().toString(36).slice(2) + Date.now().toString(36);
    const nf = (n)=> new Intl.NumberFormat("zh-TW",{maximumFractionDigits:2}).format(Number(n)||0);

    // Helpers
    const ym = (d)=> String(d||'').slice(0,7);
    const sum = (arr)=> arr.reduce((a,c)=> a + Number(c||0), 0);

    const buildSummary = (src)=>{
      const m = new Map();
      src.forEach(e=>{
        const k = ym(e.date) + "|" + (e.category||"其他");
        m.set(k,(m.get(k)||0)+Number(e.amount||0));
      });
      const rows=[];
      for (const [k,v] of m) {
        const [month,category] = k.split("|");
        rows.push({ month, category, total: Number(v.toFixed(2)) });
      }
      rows.sort((a,b)=> a.month===b.month ? a.category.localeCompare(b.category) : a.month.localeCompare(b.month));
      return rows;
    };

    // Chart component (auto-destroys on rerender)
    const BarChart = ({ labels, datasets, title })=>{
      const ref = useRef(null);
      const chartRef = useRef(null);
      useEffect(()=>{
        if (!ref.current) return;
        if (chartRef.current) { chartRef.current.destroy(); }
        chartRef.current = new Chart(ref.current, {
          type: 'bar',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' }, title: { display: !!title, text: title } },
            scales: { y: { ticks: { callback: (v)=> nf(v) } } }
          }
        });
        return ()=> { if (chartRef.current) chartRef.current.destroy(); };
      }, [JSON.stringify(labels), JSON.stringify(datasets), title]);
      return <div className="h-72"><canvas ref={ref} /></div>;
    };

    const DoughnutChart = ({ labels, data, title })=>{
      const ref = useRef(null);
      const chartRef = useRef(null);
      useEffect(()=>{
        if (!ref.current) return;
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(ref.current, {
          type: 'doughnut',
          data: { labels, datasets: [{ data }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ title:{ display:!!title, text:title } } }
        });
        return ()=> { if (chartRef.current) chartRef.current.destroy(); };
      }, [JSON.stringify(labels), JSON.stringify(data), title]);
      return <div className="h-72"><canvas ref={ref} /></div>;
    };

    const SummaryTable = ({ entries })=>{
      const rows = React.useMemo(()=>buildSummary(entries),[entries]);
      if (!rows.length) return <div className="text-slate-400">沒有可彙總的資料</div>;
      return (
        <table className="w-full text-sm">
          <thead>
            <tr className="border-b bg-slate-50 text-slate-600">
              <th className="text-left p-2">月份</th>
              <th className="text-left p-2">分類</th>
              <th className="text-right p-2">總金額</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r,i)=> (
              <tr key={i} className="border-b last:border-0 hover:bg-slate-50">
                <td className="p-2">{r.month}</td>
                <td className="p-2">{r.category}</td>
                <td className="p-2 text-right font-medium">{nf(r.total)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      );
    };

    const App = () => {
      const [entries,setEntries] = useState([]);
      const [query,setQuery] = useState("");
      const [categoryFilter,setCategoryFilter] = useState("");
      const [monthFilter,setMonthFilter] = useState("");
      const [methodFilter,setMethodFilter] = useState("");
      const [form,setForm] = useState({
        date: new Date().toISOString().slice(0,10),
        category: "餐飲",
        method: "現金",
        amount: 0,
        item: "",
        note: ""
      });
      const [editingId,setEditingId] = useState(null);

      useEffect(()=>{
        try{ const raw = localStorage.getItem("ledger_entries_v1"); if(raw) setEntries(JSON.parse(raw)); } catch {}
      },[]);
      useEffect(()=>{
        try{ localStorage.setItem("ledger_entries_v1", JSON.stringify(entries)); } catch {}
      },[entries]);

      const upsertEntry = (e)=>{
        e.preventDefault();
        if (!form.date || !form.item) return;
        const amountNum = Number(form.amount);
        if (Number.isNaN(amountNum)) return alert("金額需為數字");
        const payload = { ...form, id: editingId || uid(), amount: amountNum };
        setEntries(prev => editingId ? prev.map(p=>p.id===editingId?payload:p) : [payload, ...prev]);
        setForm({ date:new Date().toISOString().slice(0,10), category:"餐飲", method:"現金", amount:0, item:"", note:"" });
        setEditingId(null);
      };

      const onEdit = (entry)=>{ setEditingId(entry.id); setForm({ ...entry }); window.scrollTo({top:0,behavior:"smooth"}); };
      const onDelete = (id)=>{ if(confirm("確定要刪除嗎？")) setEntries(prev=>prev.filter(p=>p.id!==id)); };
      const clearAll = ()=>{ if(entries.length && confirm("確定清空全部資料？此動作無法復原")) setEntries([]); };

      const filtered = useMemo(()=> entries.filter(e =>
        (!query || [e.item,e.category,e.note,e.method].some(t=> String(t||'').toLowerCase().includes(query.toLowerCase())) || String(e.amount).includes(query)) &&
        (!categoryFilter || e.category===categoryFilter) &&
        (!methodFilter || e.method===methodFilter) &&
        (!monthFilter || ym(e.date)===monthFilter)
      ),[entries,query,categoryFilter,methodFilter,monthFilter]);

      const total = useMemo(()=> filtered.reduce((a,c)=> a + Number(c.amount||0), 0), [filtered]);

      // ----- Chart data -----
      // Monthly income vs expense (all data)
      const byMonth = useMemo(()=>{
        const map = new Map(); // ym -> { income, expense }
        entries.forEach(e=>{
          const key = ym(e.date);
          const amt = Number(e.amount||0);
          if (!map.has(key)) map.set(key, { income:0, expense:0 });
          if (amt < 0) map.get(key).income += Math.abs(amt);
          else map.get(key).expense += amt;
        });
        const labels = Array.from(map.keys()).sort();
        return {
          labels,
          income: labels.map(k=> Number((map.get(k)?.income||0).toFixed(2))),
          expense: labels.map(k=> Number((map.get(k)?.expense||0).toFixed(2))),
        };
      }, [entries]);

      // Category expense breakdown for current filter (only expenses > 0)
      const byCategory = useMemo(()=>{
        const map = new Map(); // category -> expense
        filtered.forEach(e=>{
          const amt = Number(e.amount||0);
          if (amt > 0) map.set(e.category || "其他", (map.get(e.category||"其他")||0) + amt);
        });
        const labels = Array.from(map.keys()).sort();
        const data = labels.map(k=> Number((map.get(k)||0).toFixed(2)));
        return { labels, data };
      }, [filtered]);

      const exportExcel = ()=>{
        if (!entries.length) return alert("沒有資料可匯出");
        const ws = XLSX.utils.json_to_sheet(entries.map(({id,...rest})=>rest));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "記帳");
        const ws2 = XLSX.utils.json_to_sheet(buildSummary(entries));
        XLSX.utils.book_append_sheet(wb, ws2, "彙總");
        XLSX.writeFile(wb, "ledger.xlsx");
      };

      return (
        <div>
          <header className="bg-white border-b p-4 flex justify-between items-center">
            <h1 className="text-xl font-bold">💰 簡易記帳</h1>
            <div className="flex gap-2">
              <button onClick={exportExcel} className="px-3 py-1.5 rounded bg-emerald-600 text-white">匯出 Excel</button>
              <button onClick={clearAll} className="px-3 py-1.5 rounded bg-rose-600 text-white">清空</button>
            </div>
          </header>

          <main className="max-w-5xl mx-auto p-4 space-y-6">
            <form onSubmit={upsertEntry} className="grid md:grid-cols-6 gap-3 bg-white p-4 rounded-2xl shadow">
              <input type="date" className="border p-2 rounded-xl md:col-span-2" value={form.date} onChange={e=>setForm(f=>({...f,date:e.target.value}))} required />
              <input placeholder="品項" className="border p-2 rounded-xl md:col-span-2" value={form.item} onChange={e=>setForm(f=>({...f,item:e.target.value}))} required />
              <select className="border p-2 rounded-xl" value={form.category} onChange={e=>setForm(f=>({...f,category:e.target.value}))}>
                {CATEGORIES.map(c=> <option key={c}>{c}</option>)}
              </select>
              <select className="border p-2 rounded-xl" value={form.method} onChange={e=>setForm(f=>({...f,method:e.target.value}))}>
                {METHODS.map(m=> <option key={m}>{m}</option>)}
              </select>
              <input type="number" step="0.01" placeholder="金額（支出正、收入負）" className="border p-2 rounded-xl md:col-span-2" value={form.amount} onChange={e=>setForm(f=>({...f,amount:e.target.value}))} required />
              <input placeholder="備註" className="border p-2 rounded-xl md:col-span-4" value={form.note} onChange={e=>setForm(f=>({...f,note:e.target.value}))} />
              <button type="submit" className="md:col-span-6 bg-slate-900 text-white py-2 rounded-2xl">{editingId ? "更新紀錄" : "新增紀錄"}</button>
            </form>

            <div className="bg-white p-4 rounded-2xl shadow space-y-3">
              <h2 className="font-semibold">篩選 / 搜尋</h2>
              <div className="grid md:grid-cols-4 gap-3">
                <input placeholder="關鍵字（品項/分類/備註/金額）" className="border p-2 rounded-xl" value={query} onChange={e=>setQuery(e.target.value)} />
                <select className="border p-2 rounded-xl" value={categoryFilter} onChange={e=>setCategoryFilter(e.target.value)}>
                  <option value="">所有分類</option>
                  {CATEGORIES.map(c=> <option key={c}>{c}</option>)}
                </select>
                <select className="border p-2 rounded-xl" value={methodFilter} onChange={e=>setMethodFilter(e.target.value)}>
                  <option value="">所有付款方式</option>
                  {METHODS.map(m=> <option key={m}>{m}</option>)}
                </select>
                <input type="month" className="border p-2 rounded-xl" value={monthFilter} onChange={e=>setMonthFilter(e.target.value)} />
              </div>
              <div className="text-sm text-slate-600">筆數：{filtered.length}，合計：<span className="font-semibold">{nf(total)}</span></div>
            </div>

            <div className="grid md:grid-cols-2 gap-4">
              <section className="bg-white p-4 rounded-2xl shadow">
                <h2 className="font-semibold mb-2">月度收入 vs 支出</h2>
                <BarChart
                  labels={byMonth.labels}
                  datasets={[
                    { label: "收入", data: byMonth.income },
                    { label: "支出", data: byMonth.expense }
                  ]}
                  title="每月總覽（收入取負數絕對值，支出為正數合計）"
                />
              </section>

              <section className="bg-white p-4 rounded-2xl shadow">
                <h2 className="font-semibold mb-2">分類支出分布（套用上方篩選）</h2>
                <DoughnutChart
                  labels={byCategory.labels}
                  data={byCategory.data}
                  title="各分類支出占比"
                />
              </section>
            </div>

            <div className="bg-white p-2 md:p-4 rounded-2xl shadow overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b bg-slate-50 text-slate-600">
                    <th className="text-left p-2">日期</th>
                    <th className="text-left p-2">品項</th>
                    <th className="text-left p-2">分類</th>
                    <th className="text-right p-2">金額</th>
                    <th className="text-left p-2">付款</th>
                    <th className="text-left p-2">備註</th>
                    <th className="p-2">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.map(e => (
                    <tr key={e.id} className="border-b last:border-0 hover:bg-slate-50">
                      <td className="p-2 whitespace-nowrap">{e.date}</td>
                      <td className="p-2">{e.item}</td>
                      <td className="p-2">{e.category}</td>
                      <td className="p-2 text-right">{nf(e.amount)}</td>
                      <td className="p-2 whitespace-nowrap">{e.method}</td>
                      <td className="p-2">{e.note}</td>
                      <td className="p-2 whitespace-nowrap">
                        <button onClick={()=>{ setEditingId(e.id); setForm({...e}); window.scrollTo({top:0,behavior:'smooth'}); }} className="px-2 py-1 rounded-lg border mr-2">編輯</button>
                        <button onClick={()=>{ if(confirm('確定要刪除嗎？')) setEntries(prev=>prev.filter(p=>p.id!==e.id)); }} className="px-2 py-1 rounded-lg border">刪除</button>
                      </td>
                    </tr>
                  ))}
                  {!filtered.length && (
                    <tr><td colSpan="7" className="p-6 text-center text-slate-400">目前沒有資料，先在上方新增一筆吧！</td></tr>
                  )}
                </tbody>
              </table>
            </div>

            <div className="bg-white p-4 rounded-2xl shadow">
              <h2 className="font-semibold mb-2">月度/分類彙總（表格）</h2>
              <SummaryTable entries={filtered}/>
            </div>
          </main>

          <footer className="py-8 text-center text-xs text-slate-400">
            Made with ❤ for your budgeting • 支持收入填負數、支出填正數
          </footer>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
